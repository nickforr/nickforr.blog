<!DOCTYPE html>
<html lang="en">

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="generator" content="Hugo 0.21" />

  <title>Loopy annuities &middot; nickforr</title>

  
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/0.6.2/pure-min.css">

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/0.6.2/grids-responsive-old-ie-min.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/0.6.2/grids-responsive-min.css">
  <!--<![endif]-->

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="/css/side-menu-old-ie.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="/css/side-menu.css">
  <!--<![endif]-->

  <link rel="stylesheet" href="/css/blackburn.css">

  
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">

  
  <link href="https://fonts.googleapis.com/css?family=Raleway" rel="stylesheet" type="text/css">

  
  

  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.11.0/styles/androidstudio.min.css">
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.11.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
  

  <link rel="shortcut icon" href="/img/favicon.ico" type="image/x-icon" />

  
  

</head>


<body>
<div id="layout">

  
<a href="#menu" id="menuLink" class="menu-link">
  
  <span></span>
</a>
<div id="menu">

  
  <a class="pure-menu-heading brand" href="/">nickforr</a>


  <div class="pure-menu">
    <ul class="pure-menu-list">
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="/post/"><i class='fa fa-list fa-fw'></i>Posts</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="/about/"><i class='fa fa-user fa-fw'></i>About</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="/"><i class='fa fa-home fa-fw'></i>Home</a>
      
        </li>
      
    </ul>
  </div>

  <div class="pure-menu social">
  <ul class="pure-menu-list">

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://twitter.com/nickforr" target="_blank"><i class="fa fa-twitter-square fa-fw"></i>Twitter</a>
    </li>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://linkedin.com/in/nick-forrester-2b9b1a66/" target="_blank"><i class="fa fa-linkedin-square fa-fw"></i>LinkedIn</a>
    </li>
    

    

    

    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://github.com/nickforr" target="_blank"><i class="fa fa-github-square fa-fw"></i>GitHub</a>
    </li>
    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://stackoverflow.com/users/5812231" target="_blank"><i class="fa fa-stack-overflow fa-fw"></i>Stack Overflow</a>
    </li>
    

    

    

    

    

    

    

    

    

    

  </ul>
</div>


  <div>
  <div class="small-print">
    <small>&copy; 2017. All rights reserved.</small>
  </div>
  <div class="small-print">
    <small>Built with&nbsp;<a href="https://github.com/rstudio/blogdown/" target="_blank">blogdown</a> and&nbsp;<a href="https://gohugo.io/" target="_blank">Hugo</a></small>
    <small>Theme&nbsp;<a href="https://github.com/yoshiharuyamashita/blackburn" target="_blank">Blackburn</a></small>
  </div>
</div>

</div>


  <div id="main">


<div class="header">
  <h1>Loopy annuities</h1>
  <h2></h2>
</div>
<div class="content">

  <div class="post-meta">

  <div>
    <i class="fa fa-calendar fa-fw"></i>
    <time>06 Jul 2017</time>
  </div>

  

  
  
  
  <div>
    <i class="fa fa-folder fa-fw"></i>
    
      <a class="post-taxonomy-topic" href="/topics/r">R</a>
    
  </div>
  
  

  
  
  
  <div>
    <i class="fa fa-tags fa-fw"></i>
    
      <a class="post-taxonomy-tag" href="/tags/monte-carlo">Monte Carlo</a>&nbsp;&#47;
    
      <a class="post-taxonomy-tag" href="/tags/loops">Loops</a>&nbsp;&#47;
    
      <a class="post-taxonomy-tag" href="/tags/economic-scenario-generator">economic scenario generator</a>
    
  </div>
  
  

</div>

  <p>I was tidying up some R code that involved some ‘looping’ and wondered whether the approach I’d taken could be improved uppon (I’d had nagging doubts over the approach but it worked and seemed fast enough, so hadn’t bothered refactoring it until now).</p>
<p>Background is that at work we use a lot of monte carlo simulations through economic scenario generators [<a href="https://www.actuaries.org.uk/learn-develop/attend-event/economic-scenario-generators" class="uri">https://www.actuaries.org.uk/learn-develop/attend-event/economic-scenario-generators</a>] and so are dealing with matrices with dimensions representing timesteps (for projecting, for example, interest rates) and simulations.</p>
<p>In this specific case, I was looking to calculate projections of annuity prices, across a large number of simulated paths for interest rates.</p>
<p>often the models built around the output from these don’t lend themselves neatly to apply / map methods (they’re typically more suited to accumulate or reduce methods).</p>
<p>In this case, I wanted to calculate the</p>
<p>through to keep track of some benchmarking of a couple of alternative looping approaches I was exploring</p>
<p>Inspired by the request from (<span class="citation">@hrbrmstr</span>)[<a href="https://rud.is/b/" class="uri">https://rud.is/b/</a>] for short posts on useful topics, I thought</p>
<p>Reference <a href="http://r.789695.n4.nabble.com/Raising-a-vector-to-the-power-of-elements-of-another-vector-td4690440.html" class="uri">http://r.789695.n4.nabble.com/Raising-a-vector-to-the-power-of-elements-of-another-vector-td4690440.html</a> (googling led me to the archive for the mailing list <a href="mailto:r-help@r-project.org">r-help@r-project.org</a>)</p>
<pre class="r"><code>library(tidyverse)</code></pre>
<pre><code>## Loading tidyverse: ggplot2
## Loading tidyverse: tibble
## Loading tidyverse: tidyr
## Loading tidyverse: readr
## Loading tidyverse: purrr
## Loading tidyverse: dplyr</code></pre>
<pre><code>## Warning: package &#39;dplyr&#39; was built under R version 3.4.1</code></pre>
<pre><code>## Conflicts with tidy packages ----------------------------------------------</code></pre>
<pre><code>## filter(): dplyr, stats
## lag():    dplyr, stats</code></pre>
<pre class="r"><code>yieldData &lt;- matrix(rnorm(250000, 0.03, 0.1), nrow = 50)
yieldData[1, ] &lt;- 0

paymentProbs &lt;- rep(0.03, 60)


y &lt;- yieldData[3, ]
z &lt;- drop(outer(1 + y, -seq_along(paymentProbs), &quot;^&quot;) %*% paymentProbs)

zz &lt;- purrr::map_dbl(y, ~ paymentProbs %*% ((1 + .x) ^ -seq_along(paymentProbs)))
all.equal(z, zz)</code></pre>
<pre><code>## [1] TRUE</code></pre>
<pre class="r"><code>microbenchmark::microbenchmark({
  x_incomplete &lt;-
    t(apply(yieldData, 1, function(y) {
      drop(outer(1 + y, -seq_along(paymentProbs), &quot;^&quot;) %*% paymentProbs)
    }))
}, times = 20, unit = &quot;ms&quot;)</code></pre>
<pre><code>## Unit: milliseconds
##                                                                                                                                                         expr
##  {     x_incomplete &lt;- t(apply(yieldData, 1, function(y) {         drop(outer(1 + y, -seq_along(paymentProbs), &quot;^&quot;) %*%              paymentProbs)     })) }
##      min       lq    mean  median       uq      max neval
##  638.165 646.4296 681.634 654.146 698.9033 895.9153    20</code></pre>
<pre class="r"><code>microbenchmark::microbenchmark({
  x &lt;- yieldData * 0
  for (i in 1:nrow(x)) {
    probs &lt;-
      if (i == 1) {
        paymentProbs
      } else {
        tail(paymentProbs, -i + 1) / paymentProbs[i - 1]
      }
    x[i, ] &lt;-
      drop(
        outer(1 + yieldData[i, ], -seq_along(probs), &quot;^&quot;) %*% probs
      )
  }
}, times = 20, unit = &quot;ms&quot;)</code></pre>
<pre><code>## Unit: milliseconds
##                                                                                                                                                                                                                                                                                                                expr
##  {     x &lt;- yieldData * 0     for (i in 1:nrow(x)) {         probs &lt;- if (i == 1) {             paymentProbs         }         else {             tail(paymentProbs, -i + 1)/paymentProbs[i - 1]         }         x[i, ] &lt;- drop(outer(1 + yieldData[i, ], -seq_along(probs),              &quot;^&quot;) %*% probs)     } }
##       min       lq     mean   median       uq      max neval
##  383.7155 395.1532 455.2577 455.1877 500.5438 554.7346    20</code></pre>
<pre class="r"><code>microbenchmark::microbenchmark({
  xx &lt;-
    purrr::map(
      1:nrow(yieldData),
      function(i) {
        probs &lt;-
          if (i == 1) {
            paymentProbs
          } else {
            tail(paymentProbs, -i + 1) / paymentProbs[i - 1]
          }
        purrr::map_dbl(
          yieldData[i, ],
          ~ probs %*% ((1 + .x) ^ -seq_along(probs))
        )
      }
    ) %&gt;%
    purrr::flatten_dbl() %&gt;%
    matrix(ncol = ncol(yieldData), byrow = TRUE)
}, times = 20, unit = &quot;ms&quot;)</code></pre>
<pre><code>## Unit: milliseconds
##                                                                                                                                                                                                                                                                                                                                                                                       expr
##  {     xx &lt;- purrr::map(1:nrow(yieldData), function(i) {         probs &lt;- if (i == 1) {             paymentProbs         }         else {             tail(paymentProbs, -i + 1)/paymentProbs[i - 1]         }         purrr::map_dbl(yieldData[i, ], ~probs %*% ((1 + .x)^-seq_along(probs)))     }) %&gt;% purrr::flatten_dbl() %&gt;% matrix(ncol = ncol(yieldData),          byrow = TRUE) }
##       min      lq    mean   median       uq      max neval
##  804.9208 991.663 1104.55 1057.097 1197.283 1591.764    20</code></pre>
<pre class="r"><code>all.equal(x, xx)</code></pre>
<pre><code>## [1] TRUE</code></pre>


  
<div class="prev-next-post pure-g">
  <div class="pure-u-1-24" style="text-align: left;">
    
    <a href="/post/testing-ci-of-blog/"><i class="fa fa-chevron-left"></i></a>
    
  </div>
  <div class="pure-u-10-24">
    
    <nav class="prev">
      <a href="/post/testing-ci-of-blog/">Testing CI of blog</a>
    </nav>
    
  </div>
  <div class="pure-u-2-24">
    &nbsp;
  </div>
  <div class="pure-u-10-24">
    
    <nav class="next">
      <a href="/post/why-i-learnt-r/">Why I learnt R</a>
    </nav>
    
  </div>
  <div class="pure-u-1-24" style="text-align: right;">
    
    <a href="/post/why-i-learnt-r/"><i class="fa fa-chevron-right"></i></a>
    
  </div>
</div>



  

</div>

</div>
</div>
<script src="/js/ui.js"></script>




</body>
</html>

